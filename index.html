<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8" /><title>To-Mermaid Viewer</title>

<!-- Mermaid -->
<script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs" difer></script>

<!-- DOT -->
<script src="https://cdn.jsdelivr.net/npm/viz.js@2.1.2/viz.js" difer></script>
<script src="https://cdn.jsdelivr.net/npm/viz.js@2.1.2/full.render.js" difer></script>

<!-- Vega-Embed -->
<script src="https://cdn.jsdelivr.net/npm/vega@6" difer></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@6" difer></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6" difer></script>
  
<style>
body {font-family: sans-serif; margin: 1rem;}
a#bm {display: inline-block; padding: .4rem .8rem; background: #0069d9; color: #fff;
     text-decoration: none; border-radius: 4px;}
#container > .block {
  border: 1px solid #ccc;
  border-radius: 0.5rem;
  margin: 1rem 0;
  padding: 1rem;
  background: white;
  opacity: 0;
  transition: background-color 1s ease, opacity 1s ease;
}
.block-label {
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 0.5rem;
}
.block-content > .mermaid {
  margin-top: 0.5rem;
}
</style>
</head><body>

<h1>To-Mermaid Viewer</h1>
使い方
  <ol>
  <li>このリンクを<a id="bm">🧜‍♀️to-Mermaid🧜‍♀️</a>ブックマークバーへドラッグしてブックマークレットを追加。</li>
  <li>MermaidコードのあるChatGPTチャットでブックマークレットをクリック。</li>
</ol>
新しいウィンドウが開いてMermaidコードを図に変換して表示します。以降はコード追加されるたびに図も追加されます。

<hr><div id="container"></div>

<script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
mermaid.initialize({ startOnLoad: false });

(function pastelize() {
  const t = new Date(document.lastModified).getTime();
  let hue = (t / 6e4) % 360;
  hue = (hue * 121 + 47) % 360;
  document.body.style.background = `hsl(${hue}, 70%, 88%)`;
  console.log("to-mermaid ◆ lastModified =", document.lastModified, "→ hue", hue);
})();

const version = "20250427-1256";
  
async function getScriptText(url) {
  const response = await fetch(url);
  if (!response.ok) throw new Error('Failed to fetch file');
  return await response.text();
}
getScriptText('./bookmarklet.js').then(code => {
  const bm_code = "javascript:(function(){" + code + "})()".replace(
    "BM_VERSION_PLACEHOLDER", version
  );
  const bm = document.getElementById("bm");
  bm.href = bm_code;
});

const rendered = new Set();
function createBlock(lang, code) {
  if (rendered.has(code)) return;
  rendered.add(code);

  const container = document.getElementById("container");

  const block = document.createElement("div");
  block.className = "block";

  const label = document.createElement("div");
  label.className = "block-label";
  label.textContent = lang;

  const content = document.createElement("div");
  content.className = "block-content";

  const div = document.createElement("div");
  div.className = "plain"; // dummy

  //original div = document.createElement("div"); // original
  //original.textContent = code; // 保存しておく。
    
  content.appendChild(div);
  block.appendChild(label);
  block.appendChild(content);
  container.appendChild(block);

  if (lang === "mermaid") {
    div.className = "mermaid";
    div.textContent = code; // ?
    mermaid.run({ nodes: [div] });
    
  } else if (lang === "dot") {
    
    const viz = new Viz();
    viz.renderSVGElement(code).then((elem) => {
      console.error("to-mermaid ▶︎ DOT描画成功");
      div.appendChild(elem); // hack
    }).catch(error => {
    console.error("to-mermaid ▶︎ DOT描画失敗", error);
  });


  } else if (lang === "json") { // vega-lite
    let json;
    try {
      json = JSON.parse(code);
    } catch (e) {
      console.error("to-mermaid ▶︎ JSONパース失敗", e);
      label.textContent += " - faild to parse " + e;
      div.textContent = code;
    }
    
    if ( json["$schema"] === "https://vega.github.io/schema/vega-lite/v5.json" ) {
      label.textContent += " - vega-lite";
      div.textContent = code;
      try {
        vegaEmbed(div, json, {}).then(() => {
          console.log("to-mermaid ▶︎ Vega-Lite描画完了");
        }).catch(err => {
          console.error("to-mermaid ▶︎ Vega-Lite描画失敗", err);
          label.textContent += " - faild to draw " + err;
        });
      } catch (e) {
          console.error("to-mermaid ▶︎ Vega-Lite描画失敗", e);
          label.textContent += " - faild to draw " + e;
      }
    } else {
      label.textContent += " - unknown json format.";
    }
  } else {
    //div.textContent = "not supported";
    label.textContent += " - not supported"
  }

  requestAnimationFrame(() => {
    block.style.opacity = 1;
    block.style.backgroundColor = "hsl(0, 0%, 98%)";
  });

  scrollToBottom();
}

function scrollToBottom() {
  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}

window.addEventListener("message", ev => {
  const type = ev.data?.type;
  if (!type) {
    return;
  } else if ( type === "bmVersion" ) {
    const bmVersion = ev.data?.version;
    console.log("to-mermaid ◆ 受信 bookmarklet version:", bmVersion);
    if ( bmVersion != version ) {
      const container = document.getElementById("container");
      const block = document.createElement("div");
      block.className = "block";
      block.textContent = `Bookmarkletを更新してください。現在：${version} BM:${bmVersion}` 
      content.appendChild(block);  
    }
  } else if ( type === "codeBlocks" ) {
    const blocks = ev.data?.blocks;
    if (!blocks) return;
    console.log("to-mermaid ◆ 受信 ", blocks.length);
    blocks.forEach(({ lang, code }) => {
      createBlock(lang, code);
    });
  } else {
    console.log("to-mermaid ◆ 受信 unknowntype", type);
  }
});
</script>

</body></html>
