<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8" /><title>to-Mermaid Viewer</title>

<!-- Mermaid -->
<script type="module"
  src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs"></script>

<style>
body{font-family:sans-serif;margin:1rem;}
a#bm{display:inline-block;padding:.4rem .8rem;background:#0069d9;color:#fff;
     text-decoration:none;border-radius:4px;}
#container>.mermaid{margin:1rem 0;}
</style>
</head><body>

<h1>to-Mermaid Viewer</h1>
<p>① このリンクをブックマークバーへドラッグ → ② ChatGPT でクリック</p>
<a id="bm">Install to-Mermaid</a>

<hr><div id="container"></div>

<script type="module">
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
  mermaid.initialize({ startOnLoad:false });

  /* 背景色を lastModified で決定（パステル） */
  (function pastelize () {
    const t = new Date(document.lastModified).getTime();
    let hue = (t / 6e4) % 360;                      // 分単位で変化
    hue = ( hue * 121 + 47 ) % 360; // randomize
      
    document.body.style.background = `hsl(${hue}, 70%, 88%)`;
    console.log("to-mermaid ◀︎ lastModified =", document.lastModified,
                "→ hue", hue);
  })();

  /* 描画関数群 */
  const rendered = new Set();
  function renderMermaid (code) {
    if (rendered.has(code)) return;
    rendered.add(code);
    const div = document.createElement("div");
    div.className = "mermaid"; div.textContent = code;
    document.getElementById("container").appendChild(div);
    mermaid.run({ nodes:[div] });
  }
  function renderDefault (lang, code) {
    console.log(lang, " not supported");
  }

  /* postMessage 受信 */
  window.addEventListener("message", ev => {
    const blocks = ev.data?.blocks; if (!blocks) return;
    console.log("to-mermaid ◀︎ 受信", blocks.length); //, "blocks", blocks);
    blocks.forEach(({lang, code}) => {
      if (lang === "mermaid")      renderMermaid(code);
      else      renderDefault(lang, code);
    });
  });
</script>
</body></html>
