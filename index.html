<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8" /><title>To-Mermaid Viewer</title>

<style>
body {font-family: sans-serif; margin: 1rem;}
a#bm {display: inline-block; padding: .4rem .8rem; background: #0069d9; color: #fff;
     text-decoration: none; border-radius: 4px;}
#container > .block {
  border: 1px solid #ccc;
  border-radius: 1rem;
  margin: 1rem 0;
  padding: 1rem;
  background: white;
  opacity: 0;
  transition: background-color 1s ease, opacity 1s ease;
}
.block-label {
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 0.5rem;
}
.block-content > .mermaid {
  margin-top: 0.5rem;
}
</style>
</head><body>

<h1>To-Mermaid Viewer</h1>
<ol>
  <li>このリンクをブックマークバーへドラッグ <a id="bm">🧜‍♀️to-Mermaid🧜‍♀️</a></li>
  <li>MermaidコードのあるChatGPTチャットでクリック</li>
  <li>新しいウィンドウが開いて図を表示。以降はコード追加されるたびに図も追加。</li>
</ol>

<hr><div id="container"></div>

<script type="module">
// 利用するスクリプトURLを言語別にまとめる
const scripts = {
  "mermaid": ["https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs"],
  "dot": [
    "https://cdn.jsdelivr.net/npm/viz.js@2.1.2/viz.js",
    "https://cdn.jsdelivr.net/npm/viz.js@2.1.2/full.render.js"
  ],
  "vega-lite": [
    "https://cdn.jsdelivr.net/npm/vega@6",
    "https://cdn.jsdelivr.net/npm/vega-lite@6",
    "https://cdn.jsdelivr.net/npm/vega-embed@6"
  ]
};

// 読み込み済み言語を記録
const loaded = {};

// 必要なライブラリを動的にロード
async function ensure(lang) {
  if (loaded[lang]) return;

  if (lang === "mermaid") {
    // mermaidはimportで読み込む
    const mermaid = await import(scripts["mermaid"][0]);
    mermaid.initialize({ startOnLoad: false });
    window.mermaid = mermaid;
    loaded[lang] = true;
    console.log("Mermaid読み込み完了");
  } else if (lang === "dot" || lang === "vega-lite") {
    // dot, vega-liteはscriptタグで読み込む
    await Promise.all(scripts[lang].map(src => new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    })));
    loaded[lang] = true;
    console.log(`${lang}関連読み込み完了`);
  } else {
    // サポート外の言語ならエラー表示
    console.error(`Unsupported language for loading: ${lang}`);
  }
}

// ページの背景色をlastModified由来でランダム決定
(function pastelize() {
  const t = new Date(document.lastModified).getTime();
  let hue = (t / 6e4) % 360;
  hue = (hue * 121 + 47) % 360;
  document.body.style.background = `hsl(${hue}, 70%, 88%)`;
})();

// ブックマークレットコードを動的にセット
async function getScriptText(url) {
  const response = await fetch(url);
  if (!response.ok) throw new Error('Failed to fetch file');
  return await response.text();
}
getScriptText('./bookmarklet.js').then(code => {
  const bm_code = "javascript:(function(){" + code + "})()";
  const bm = document.getElementById("bm");
  bm.href = bm_code;
});

// 図を一意に管理するためのセット
const rendered = new Set();

// 図ブロックを作成する
async function createBlock(lang, code) {
  if (rendered.has(code)) return;
  rendered.add(code);

  const container = document.getElementById("container");

  const block = document.createElement("div");
  block.className = "block";

  const label = document.createElement("div");
  label.className = "block-label";
  label.textContent = lang;

  const content = document.createElement("div");
  content.className = "block-content";

  const div = document.createElement("div");
  div.className = (lang === "mermaid" || lang === "vega-lite" || lang === "dot") ? lang : "plain";

  content.appendChild(div);
  block.appendChild(label);
  block.appendChild(content);
  container.appendChild(block);

  await ensure(lang);

  if (lang === "mermaid") {
    window.mermaid.run({ nodes: [div] });
  } else if (lang === "vega-lite") {
    try {
      const spec = JSON.parse(code);
      vegaEmbed(div, spec, {});
    } catch (e) {
      console.error("Vega-Liteパース失敗", e);
      div.textContent = "Invalid Vega-Lite JSON";
    }
  } else if (lang === "dot") {
    const viz = new Viz();
    viz.renderSVGElement(code)
      .then(svg => div.appendChild(svg))
      .catch(err => console.error("DOT描画失敗", err));
  } else {
    div.textContent = code;
  }

  // フェードインアニメーション
  requestAnimationFrame(() => {
    block.style.opacity = 1;
    block.style.backgroundColor = "hsl(0, 0%, 98%)";
  });

  // 最下部に自動スクロール
  scrollToBottom();
}

// ページ最下部へスクロール
function scrollToBottom() {
  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}

// postMessage受信ハンドラ
window.addEventListener("message", ev => {
  const blocks = ev.data?.blocks;
  if (!blocks) return;
  blocks.forEach(({ lang, code }) => {
    createBlock(lang, code);
  });
});
</script>

</body></html>
