<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8" /><title>To-Mermaid Viewer</title>

<!-- Mermaid
<script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs" defer></script>
 -->
 
<!-- DOT -->
<script src="https://cdn.jsdelivr.net/npm/viz.js@2.1.2/viz.js" defere></script>
<script src="https://cdn.jsdelivr.net/npm/viz.js@2.1.2/full.render.js" defer></script>

<!-- Vega-Embed -->
<script src="https://cdn.jsdelivr.net/npm/vega@6" defer></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@6" defer></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6" defer></script>

<!-- Markmap  
<script src="https://cdn.jsdelivr.net/npm/markmap-autoloader" defer></script>
 -->
     
<style>
body {font-family: sans-serif; margin: 1rem;}
a#bm {display: inline-block; padding: .2rem .4rem; background: #0069d9; color: #fff;
     text-decoration: none; border-radius: 4px;}
#container > .block {
  border: 1px solid #ccc;
  border-radius: 0.3rem;
  margin: 1rem 0;
  padding: 1rem;
  background: white;
  opacity: 0;
  transition: background-color 1s ease, opacity 1s ease;
}
.block-label {
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 0.5rem;
}
.block-content > .mermaid {
  margin-top: 0.5rem;
}

#container > .pagetitle {
  border-radius: 0.3rem;
  margin: 1rem 0;
  padding: 0.5rem;
  
  background: #e0e0e0;
  border: 1px solid #bbb;
  color: #222;
  font-size: 1.2rem;
  font-weight: bold;
  text-align: center;
  padding: 1rem;
  border-radius: 0.5rem;
}
#container > .message {
  border-radius: 0.3rem;
  margin: 1rem 0;
  padding: 0.5rem;
  
  background: #fff8e1;
  border: 1px solid #ffcc00;
  color: #333;
  font-weight: bold;
  padding: 1rem;
  border-radius: 0.5rem;
}
</style>
</head><body>

<h1>To-Mermaid Viewer</h1>
ä½¿ã„æ–¹
  <ol>
  <li>ã“ã®ãƒªãƒ³ã‚¯â†’<a id="bm">ğŸ§œâ€â™€ï¸To-MermaidğŸ§œâ€â™€ï¸</a>ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã¸ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¿½åŠ ã€‚</li>
  <li>Mermaidã‚³ãƒ¼ãƒ‰ã®ã‚ã‚‹ChatGPTãƒãƒ£ãƒƒãƒˆï¼ˆ<a href="https://chatgpt.com/share/680e49b7-609c-8013-83cc-ba9a21eb3694">ã‚µãƒ³ãƒ—ãƒ«</a>ï¼‰ã§ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚</li>
</ol>
æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ã„ã¦Mermaidã‚³ãƒ¼ãƒ‰ã‚’å›³ã«å¤‰æ›ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚ä»¥é™ã¯ã‚³ãƒ¼ãƒ‰ãŒè¿½åŠ ã•ã‚Œã‚‹ãŸã³ã«å›³ã‚‚è¿½åŠ ã•ã‚Œã¾ã™ã€‚

<hr><div id="container"></div>

<script type="module">
//import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.6.0/+esm";
mermaid.initialize({ startOnLoad: false });

// èƒŒæ™¯å¤‰æ›´ debugç”¨
(function pastelize() {
  const t = new Date(document.lastModified).getTime();
  let hue = (t / 6e4) % 360;
  hue = (hue * 121 + 47) % 360;
  document.body.style.background = `hsl(${hue}, 70%, 88%)`;
  console.log("to-mermaid â—† lastModified =", document.lastModified, "â†’ hue", hue);
})();

const version = "20250428-0000";

// ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã—ã¦ã€ãƒªãƒ³ã‚¯ã«è¨­å®š
async function getScriptText(url) {
  const response = await fetch(url, { cache: "no-store" });
  if (!response.ok) throw new Error('Failed to fetch file');
  return await response.text();
}
getScriptText('./bookmarklet.js').then(code => {
  const bm_code = "javascript:(function(){" +
    code.replace("BM_VERSION_PLACEHOLDER", version) + 
    "})()";
  const bm = document.getElementById("bm");
  bm.href = bm_code;
});

// å…±é€š: æˆåŠŸæ™‚ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
function showBlock(block, success = true) {
  //block.style.display = "block";
  if ( success ) {
    requestAnimationFrame(() => {
      block.style.opacity = 1;
      block.style.backgroundColor = "hsl(0, 0%, 98%)";
    });
    scrollToBottom();
  } else {
    //block.display = "none";
    block.style.opacity = 1;
    block.style.backgroundColor = "hsl(0, 0%, 98%)";
  }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹
async function createBlock(type, message) {
  const container = document.getElementById("container");
  const block = document.createElement("div");

  const allowed = ["message", "pagetitle"];
  if ( allowed.includes(type) ) {
    block.className = type;    
  } else {
    console.log("invalid type", type);
  }   
  block.style.opacity = 0;
  block.textContent = message;
  container.appendChild(block);
  showBlock(block);
}
     
const rendered = new Set();
let mermaidIdCount = 0;

let codeIdCount = 0;

// ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å›³ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹
async function createCodeBlock(lang, code) {
  if (rendered.has(code)) return;
  rendered.add(code);

  // dubug
  //console.log(lang, code);
     
  const container = document.getElementById("container");
  const block = document.createElement("div");
  block.className = "block";
  block.style.opacity = 0;
  block.id = `block-${codeIdCount++}`;
  block.dataset.lang = lang; // backup
  block.dataset.code = code; // backup

  const label = document.createElement("div");
  label.className = "block-label";
  label.textContent = lang;

  const content = document.createElement("div");
  content.className = "block-content";

  const div = document.createElement("div");
  div.className = "plain";
  content.appendChild(div);
  block.appendChild(label);
  block.appendChild(content);
  container.appendChild(block);
  /*
   container
   [
    block
      label
      content
        div
    ]
  */


  try {
    if (lang === "mermaid") {
    
      // renderã‚’å‘¼ã¶ã¨DOMã«ä¸€æ™‚çš„ãªã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã€ã§ããŸsvgãŒè¿”ã•ã‚Œã‚‹ã€‚
      // é€”ä¸­ã§å¤±æ•—ã™ã‚‹ã¨ã€DOMã«ä¸€æ™‚ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãŒæ®‹ã£ãŸã¾ã¾ã«ãªã‚‹ã®ã§ã€IDã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã—ã¦å‰Šé™¤å‡¦ç†ã™ã‚‹ã€‚
       const id = `mermaid-${mermaidIdCount++}`;
       try {
         const { svg } = await mermaid.render(id, code)
         div.innerHTML = svg;
       } catch (e) {
         console.error("rendaring error in mermaid");
        label.textContent += " - rendaring error";
        div.textContent = e;
        div.style.whiteSpace = "pre";

         const elem = document.getElementById(id);
         if ( elem ) elem.remove();
         throw e; // to remove block
       }
      
    } else if (lang === "dot") {
      const viz = new Viz();
      const elem = await viz.renderSVGElement(code);
      div.appendChild(elem);

    } else if (lang === "json") {

      let json;
      try {
        json = JSON.parse(code);
      } catch (e) {
        console.error("to-mermaid:ï¸ failed to parse");
        div.style.whiteSpase = "pre";
        div.textContent = code;
        label.textContent += " - failed to parse";
        throw new Error("Failed to parse JSON");
      }

      const schema = json["$schema"];
      if ( !schema ) {
        console.error("to-mermaid: json does not have $schema");
        console.debug(code);
        label.textContent += " - no $schema provided";
        throw new Error("JSON does not have $schema");

      // vegalite
      } else if (schema === "https://vega.github.io/schema/vega-lite/v5.json") {
        label.textContent += " - vega-lite";
        div.textContent = code;
        await vegaEmbed(div, json, {});

      } else {
        console.error("to-mermaid â–¶ï¸ Unknown JSON schema:", schema);
        label.textContent += " - unknown shcema";
        throw new Error("Unknown JSON shema");
      }

    }  /*else if (lang === "markdown") { // ==> markmap
      
     
       const svg = document.createElement('svg');
       svg.style.width = "600px";
       svg.style.height = "500px";  // HACK
       div.appendChild(svg);
         
       const { Transformer } = window.markmap;
       const transformer = new Transformer();
       const { root, features } = transformer.transform(code);
     
       window.markmap.Markmap.create(svg, { features }, root);
       showBlock(block);
         
     } */
    else {
      console.error("to-mermaid â–¶ï¸ unknown language", lang);
      label.textContent += " - not supported";
      throw new Error("Unknown language");
    }

    block.dataset.success = false; // backup
    showBlock(block);
  } catch (e) {
    //container.removeChild(block);
    block.dataset.success = false; // backup
    showBlock(block, false);
  }
}

function scrollToBottom() {
  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}

window.addEventListener("message", ev => {
  const type = ev.data?.type;
  const container = document.getElementById("container");

  if (!type) return;

  if (type === "bmVersion") {
    const bmVersion = ev.data?.version;
    console.log("to-mermaid â—† å—ä¿¡ bmVersion", bmVersion);
    if (bmVersion != version) {
      createBlock("message", `Bookmarkletã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ï¼š${version} BM:${bmVersion}`);
    }
  } else if (type === "pageMoved") {
    const title = ev.data?.title;
    console.log("to-mermaid â—† å—ä¿¡ pageMoved", title);
    createBlock("pagetitle", title);
       
  } else if (type === "codeBlocks") {
    const blocks = ev.data?.blocks;
    if (!blocks) return;
    console.log("to-mermaid â—† å—ä¿¡ codeBlocks", blocks.length);
    blocks.forEach(({ lang, code }) => {
      createCodeBlock(lang, code);
    });
  } else {
    console.log("to-mermaid â—† å—ä¿¡ unknown type", type);
  }
});
</script>

</body></html>
