<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8" /><title>to-Mermaid Viewer</title>

<!-- Mermaid -->
<script type="module"
  src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs"></script>

<style>
body{font-family:sans-serif;margin:1rem;}
a#bm{display:inline-block;padding:.4rem .8rem;background:#0069d9;color:#fff;
     text-decoration:none;border-radius:4px;}
#container>.mermaid{margin:1rem 0;}
</style>
</head><body>

<h1>to-Mermaid Viewer</h1>
<p>â‘  ã“ã®ãƒªãƒ³ã‚¯ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã¸ãƒ‰ãƒ©ãƒƒã‚° â†’ â‘¡ ChatGPT ã§ã‚¯ãƒªãƒƒã‚¯</p>
<a id="bm">ğŸ§œâ€â™€ï¸to-Mermaid</a>

<hr><div id="container"></div>

<script type="module">
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
  mermaid.initialize({ startOnLoad:false });

  /* èƒŒæ™¯è‰²ã‚’ lastModified ã§æ±ºå®šï¼ˆãƒ‘ã‚¹ãƒ†ãƒ«ï¼‰ */
  (function pastelize () {
    const t = new Date(document.lastModified).getTime();
    let hue = (t / 6e4) % 360;                      // åˆ†å˜ä½ã§å¤‰åŒ–
    hue = ( hue * 121 + 47 ) % 360; // randomize
      
    document.body.style.background = `hsl(${hue}, 70%, 88%)`;
    console.log("to-mermaid â—€ï¸ lastModified =", document.lastModified,
                "â†’ hue", hue);
  })();

  // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãƒªãƒ³ã‚¯ã«è¨­å®š
  async function getScriptText(url) {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Failed to fetch script');
    const textdata = await response.text();
    return textdata;
  }
  getScriptText('bookmarklet.js').then(code => {
    const bm_code = "javascript:(function(){" + code + "})()";
    const bm = document.getElementById("bm");
    bm.href = bm_code;
  });

  

  /* æç”»é–¢æ•°ç¾¤ */
  const rendered = new Set();
  function renderMermaid (code) {
    if (rendered.has(code)) return;
    rendered.add(code);
    const div = document.createElement("div");
    div.className = "mermaid"; div.textContent = code;
    document.getElementById("container").appendChild(div);
    mermaid.run({ nodes:[div] });
  }
  function renderDefault (lang, code) {
    console.log(lang, " not supported");
  }

  /* postMessage å—ä¿¡ */
  window.addEventListener("message", ev => {
    const blocks = ev.data?.blocks; if (!blocks) return;
    console.log("to-mermaid â—€ï¸ å—ä¿¡", blocks.length); //, "blocks", blocks);
    blocks.forEach(({lang, code}) => {
      if (lang === "mermaid")      renderMermaid(code);
      else      renderDefault(lang, code);
    });
  });
</script>
</body></html>
